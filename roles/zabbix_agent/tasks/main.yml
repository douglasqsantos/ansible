---
# tasks file for zabbix_agent
- name: Remove Packages on CentOS
  yum:
    name: "{{ packages_to_remove }}"
    state: absent
    autoremove: yes
  when: ansible_distribution == 'CentOS'

- name: Remove Packages on Ubuntu
  apt:
    name: "{{ packages_to_remove }}"
    state: absent
    purge: yes
    autoremove: yes
  when: ansible_distribution == 'Ubuntu'

- name: Clean useless packages from the cache
  apt:
    autoclean: yes
  when: ansible_distribution == 'Ubuntu'

- name: Install Zabbix Release on CentOS
  yum:
    name: "{{ zbx_release_rpm }}"
    state: present
  when: ansible_distribution == 'CentOS'

- name: Install Zabbix Release on Ubuntu
  apt:
    deb: "{{ zbx_release_deb }}"
    state: present
  when: ansible_distribution == 'Ubuntu'

- name: Install Zabbix Agent on Ubuntu
  apt:
    name: "{{ zbx_packages }}"
    update_cache: yes
    state: present
  when: ansible_distribution == 'Ubuntu'
  notify: Stop Zabbix Agent

- name: Install Zabbix Agent on CentOS
  yum:
    name: "{{ zbx_packages }}"
    update_cache: yes
    state: present
  when: ansible_distribution == 'CentOS'
  notify: Stop Zabbix Agent

- name: Enable Zabbix Agent
  systemd:
    name: zabbix-agent
    enabled: yes
    masked: no

## List all the files to handle
- name: Find Zabbix Agent Files
  find:
    paths: /etc/zabbix/
    file_type: file
    patterns: '*'
    recurse: yes
  register: files_to_delete

# - name: Check the files to Handle
#   debug:
#     var: item.path
#   with_items: "{{ files_to_delete.files }}"

## Backup the Files before delete
- name: Backup Find Zabbix Agent Files
  fetch:
    src: "{{ item.path }}"
    dest: "{{ zbx_bkp_dir }}"
  with_items: "{{ files_to_delete.files }}"

## Remove Custom files
- name: Remove Custom files for Zabbix Agent
  file:
    path: "{{ item.path }}"
    state: absent
  with_items: "{{ files_to_delete.files }}"

## Creating the Custom File Directory
- name: Creating the Zabbix Agent Custom File Directory
  file:
    path: "{{ zbx_include_dir }}"
    state: directory

## Configure the Zabbix Agent
- name: Template zabbix_agentd.conf
  template:
    src: templates/zabbix_agentd.conf.j2
    dest: "{{ zbx_agent_file }}"
    backup: yes
    force: yes
    mode: 0644
    owner: root
    group: root
  notify: Restart Zabbix Agent